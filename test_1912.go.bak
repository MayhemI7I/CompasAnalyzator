package main

import (
	"fmt"
	"log"
	"os"

	"compass_analyzer/analyzer"
	"compass_analyzer/parser"
)

func main() {
	fmt.Println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
	fmt.Println("â•‘           Ğ¢Ğ•Ğ¡Ğ¢ ĞĞ›Ğ“ĞĞ Ğ˜Ğ¢ĞœĞ ĞĞ ĞšĞ•Ğ™Ğ¡Ğ• 1912                   â•‘")
	fmt.Println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

	// ĞŸÑƒÑ‚ÑŒ Ğº Ñ„Ğ°Ğ¹Ğ»Ñƒ Ğ¸Ğ· Ğ±Ñ€Ğ°ĞºĞ°
	brakPath := `Ğ‘Ñ€Ğ°Ğº\1912\SB_CMPS_CALIB_CUTTED.csv`
	fmt.Printf("ğŸ“ ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼: %s\n\n", brakPath)

	// Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
	data, err := parser.ReadCSVFile(brakPath)
	if err != nil {
		log.Fatalf("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°: %v", err)
	}

	fmt.Printf("âœ“ ĞŸÑ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¾ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹: %d\n\n", len(data))

	// Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ ÑƒĞ³Ğ»Ñ‹
	angles := make([]float64, len(data))
	for i, d := range data {
		angles[i] = d.Angle
	}

	// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ»Ğ¾Ğ³-Ñ„Ğ°Ğ¹Ğ»
	logFile, err := os.Create("test_1912_results.log")
	if err != nil {
		log.Printf("âš  ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ»Ğ¾Ğ³-Ñ„Ğ°Ğ¹Ğ»: %v", err)
		logFile = nil
	}
	defer func() {
		if logFile != nil {
			logFile.Close()
			fmt.Println("\nğŸ“„ Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ»Ğ¾Ğ³ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½ Ğ²: test_1912_results.log")
		}
	}()

	// ĞĞĞĞ›Ğ˜Ğ—Ğ˜Ğ Ğ£Ğ•Ğœ!
	fmt.Println("ğŸ” Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ñ Ğ½Ğ¾Ğ²Ñ‹Ğ¼ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ğ¾Ğ¼...\n")
	fmt.Println(string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}))

	isValid, turns := analyzer.AnalyzeCompassData(angles, logFile)

	// Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢Ğ«
	fmt.Println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
	fmt.Println("â•‘                     Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ Ğ¢Ğ•Ğ¡Ğ¢Ğ                       â•‘")
	fmt.Println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

	if isValid {
		fmt.Println("âœ… Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡: ĞšĞĞ›Ğ˜Ğ‘Ğ ĞĞ’ĞšĞ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ")
		fmt.Println("   (Ğ Ğ°Ğ½ĞµĞµ ÑÑ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ» Ğ±Ñ‹Ğ» Ğ² Ğ±Ñ€Ğ°Ğº, Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾!)")
	} else {
		fmt.Println("âŒ Ğ¡Ğ¢ĞĞ¢Ğ£Ğ¡: ĞšĞĞ›Ğ˜Ğ‘Ğ ĞĞ’ĞšĞ ĞĞ• ĞŸĞ ĞĞ¨Ğ›Ğ")
		fmt.Println("   (Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ°Ğ»ÑŒĞ½ĞµĞ¹ÑˆĞ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼Ğ°)")
	}

	fmt.Printf("\nğŸ“Š Ğ¡Ğ¢ĞĞ¢Ğ˜Ğ¡Ğ¢Ğ˜ĞšĞ:\n")
	fmt.Printf("   â€¢ Ğ’ÑĞµĞ³Ğ¾ Ğ¸Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğ¹: %d\n", len(angles))
	fmt.Printf("   â€¢ ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ¾Ğ²: %d/4\n", len(turns))

	if len(turns) > 0 {
		fmt.Println("\nğŸ”„ ĞĞĞ™Ğ”Ğ•ĞĞĞ«Ğ• ĞŸĞĞ’ĞĞ ĞĞ¢Ğ«:")
		var totalDiff float64
		for i, turn := range turns {
			fmt.Printf("   %d. %.2fÂ° â†’ %.2fÂ° (Î” = %.2fÂ°)\n",
				i+1, turn.StartAngle, turn.EndAngle, turn.Diff)
			totalDiff += turn.Diff
		}

		fmt.Printf("\n   Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ğ¾Ğ²: %.2fÂ°\n", totalDiff)
		deviation := totalDiff - 360
		if deviation < 0 {
			deviation = -deviation
		}
		fmt.Printf("   ĞÑ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚ 360Â°: %.2fÂ°\n", deviation)

		if deviation <= 15 {
			fmt.Println("   âœ“ Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ² Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ°Ñ… Ğ´Ğ¾Ğ¿ÑƒÑĞºĞ° (Â±15Â°)")
		} else {
			fmt.Println("   âœ— Ğ¡ÑƒĞ¼Ğ¼Ğ° Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞ°ĞµÑ‚ Ğ´Ğ¾Ğ¿ÑƒÑĞº")
		}
	} else {
		fmt.Println("\nâš  ĞŸĞ¾Ğ²Ğ¾Ñ€Ğ¾Ñ‚Ñ‹ Ğ½Ğµ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ñ‹")
	}

	// Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ ÑĞ¾ ÑÑ‚Ğ°Ñ€Ñ‹Ğ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ¼
	fmt.Println("\n" + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}))
	fmt.Println("\nğŸ“ˆ Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ• Ğ¡ ĞŸĞ Ğ•Ğ”Ğ«Ğ”Ğ£Ğ©Ğ•Ğ™ Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ•Ğ™:")
	fmt.Println("   Ğ¡Ñ‚Ğ°Ñ€Ñ‹Ğ¹ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼: âŒ Ğ‘Ñ€Ğ°Ğº (Ğ»Ğ¾Ğ¶Ğ½Ğ¾Ğµ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ)")
	if isValid {
		fmt.Println("   ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:  âœ… Ğ£ÑĞ¿ĞµÑˆĞ½Ğ¾ (Ğ¸ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾!)")
		fmt.Println("\nğŸ‰ Ğ£Ğ›Ğ£Ğ§Ğ¨Ğ•ĞĞ˜Ğ•: ĞšĞµĞ¹Ñ 1912 Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ!")
	} else {
		fmt.Println("   ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ°Ğ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:  âŒ Ğ‘Ñ€Ğ°Ğº")
		fmt.Println("\nâš  Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ´Ğ°Ğ»ÑŒĞ½ĞµĞ¹ÑˆĞ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²")
	}

	fmt.Println("\n" + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}) + string([]byte{0xE2, 0x94, 0x80}))
}
