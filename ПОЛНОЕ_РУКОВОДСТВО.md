# 📖 Полное руководство Compass Analyzer v2.1

## 🚀 Быстрый старт

### Запуск веб-интерфейса:
```bash
.\start_web.bat
```
Или в PowerShell:
```powershell
cd H:\Study
$env:GOMODCACHE="C:\go_modules"; $env:GOCACHE="C:\go_modules\cache"
go run . web
```

Откройте в браузере: **http://localhost:8080**

---

## 🎯 Основные вкладки

### 1️⃣ АНАЛИЗ - Единичный анализ компаса

#### Два способа загрузки:

**Способ 1: Ввод пути вручную** (быстро)
```
1. Введите путь: H:\Study\Успех\1903
2. Нажмите "Анализировать" или Enter
```

**Способ 2: Выбор папки** (удобно)
```
1. Нажмите "Открыть диалог выбора папки"
2. Выберите папку компаса
3. Введите полный путь в диалоге
```

#### Что вы получите:
- ✅ Статус калибровки (Валидно/Не прошло)
- 📊 **График с выделением зоны поворотов**:
  - 🔵 Синие точки - зона поворотов (±5 замеров)
  - ⚫ Серые точки - остальные измерения
- 📋 Таблица последовательности поворотов
- 📝 Детальный лог анализа
- 💾 Кнопка экспорта результатов

#### Новый анализ:
```
Нажмите кнопку "Анализировать" (правый верхний угол)
→ Введите новый путь
```

---

### 2️⃣ ПАКЕТНЫЙ - Массовый анализ

#### Использование:
```
1. Введите путь к папке с компасами: H:\Study\Успех
2. Нажмите "Запустить"
3. Дождитесь завершения (показывается прогресс)
4. Получите сводку:
   ✓ 38 успешно | ✗ 3 с ошибками
```

#### Детальный просмотр:
```
Нажмите 👁️ (глаз) напротив любого компаса
→ Откроется модальное окно с:
   - Графиком (с выделением зоны поворотов)
   - Таблицей поворотов
   - Детальным логом
   - Кнопкой экспорта
```

#### Автосохранение:
```
✅ Все результаты автоматически сохраняются в историю!
```

---

### 3️⃣ ИСТОРИЯ - Просмотр всех анализов

#### Структура:

```
╔══════════════════════════════════════╗
║  📅 28.10.2025                       ║
║  15 анализов: ✓ 12 | ✗ 3            ║
╠══════════════════════════════════════╣
║  Время   Компас  Статус  Повороты   ║
║  12:30   1903    ✓       4/4    👁️  ║
║  12:31   1904    ✓       4/4    👁️  ║
║  12:32   1905    ✗       3/4    👁️  ║
╚══════════════════════════════════════╝

╔══════════════════════════════════════╗
║  📅 27.10.2025                       ║
║  8 анализов: ✓ 7 | ✗ 1              ║
╠══════════════════════════════════════╣
║  ...                                 ║
╚══════════════════════════════════════╝
```

#### Фильтры:

**По статусу:**
- Все результаты
- ✓ Только успешные
- ✗ Только с ошибками

**По дате:**
- Весь период (все даты)
- **Сегодня** (по умолчанию) 📅
- 27.10.2025
- 26.10.2025
- ...

**Кнопка "Сбросить"** - вернуть фильтры к значениям по умолчанию

#### Действия:
- **Клик по дате** - развернуть/свернуть день
- **👁️** - просмотр полных деталей анализа
- **"Очистить историю"** - удалить все записи

#### Возможности:
- Хранится до 200 записей
- Полные данные для каждого анализа
- Группировка по дням
- Мгновенная фильтрация

---

### 4️⃣ НАСТРОЙКИ - Конфигурация алгоритма

#### Параметры:

| Параметр | По умолчанию | Диапазон | Рекомендуется |
|----------|--------------|----------|---------------|
| **Порог стабильности** | 5.0° | 0-20° | 3.0-7.0° |
| **Допуск поворота** | 10.0° | 0-30° | 8.0-12.0° |
| **Мин. длина сегмента** | 3 | 1-10 | 3-5 |
| **Макс. выбросов** | 2 | 0-10 | 2-3 |

#### Описание параметров:

**1. Порог стабильности:**
- Максимальное отклонение внутри стабильного сегмента
- Меньше значение = строже критерии стабильности
- Больше значение = больше допуск на колебания

**2. Допуск поворота:**
- Отклонение от идеального поворота на 90°
- Поворот считается валидным если: 80° ≤ Δ ≤ 100° (при допуске 10°)

**3. Минимальная длина сегмента:**
- Минимум измерений в стабильном сегменте
- Слишком малое значение = много ложных сегментов
- Слишком большое = можем пропустить короткие сегменты

**4. Максимум выбросов (гистерезис):**
- Допустимое количество "шумных" точек в сегменте
- Позволяет игнорировать случайные всплески

#### Функционал:

**Live Preview:**
```
При изменении значений справа обновляется превью:
┌──────────────────────────┐
│ Порог стабильности: 5.0° │
│ Допуск поворота:   ±10.0°│
│ Мин. длина сегмента:   3 │
│ Макс. выбросов:        2 │
└──────────────────────────┘
```

**Сохранение:**
```
1. Измените параметры
2. Нажмите "Сохранить настройки"
3. Настройки сохранятся в браузере
4. Применятся ко всем новым анализам
```

**Сброс:**
```
Нажмите "Сбросить по умолчанию"
→ Все параметры вернутся к заводским значениям
```

---

## 📊 Визуализация

### График углов с выделением

#### Цветовое кодирование:
- **🔵 Синие точки (крупные, яркие)**
  - Зона с поворотами
  - От первого до последнего поворота ±5 замеров
  - Хорошо видно где происходит калибровка

- **⚫ Серые точки (мелкие, тусклые)**
  - Остальные измерения
  - Менее важны для анализа

#### Легенда:
```
🔵 Зона поворотов (±5 замеров)    ⚫ Остальные измерения
```

#### Интерактивность:
- **Hover (наведение)** - показывает точные значения
- **Zoom** - приближение колесиком мыши
- **Pan** - перетаскивание графика

---

## 💡 Практические примеры

### Пример 1: Проверка одного компаса

```
Задача: Проверить компас 1903 из папки Успех

Шаги:
1. Вкладка "Анализ"
2. Введите: H:\Study\Успех\1903
3. Нажмите "Анализировать"

Результат:
✅ Статус: Валидно
🔄 Найдено поворотов: 4/4
📊 График показывает 4 чистых поворота на ~90°

Действия:
- Посмотреть детальный лог
- Экспортировать результаты
- Запись автоматически сохранена в историю
```

---

### Пример 2: Массовая проверка партии

```
Задача: Проверить всю папку Успех (41 компас)

Шаги:
1. Вкладка "Пакетный"
2. Введите: H:\Study\Успех
3. Нажмите "Запустить"
4. Дождитесь завершения (~5-10 сек)

Результат:
✓ 38 успешно | ✗ 3 с ошибками

Детали:
- Кликните 👁️ на любой строке
- Посмотрите график и лог
- Экспортируйте нужные результаты

История:
✅ Все 41 результат сохранены автоматически!
```

---

### Пример 3: Анализ истории за день

```
Задача: Посмотреть все проверки за сегодня

Шаги:
1. Вкладка "История"
2. Фильтры уже установлены на "Сегодня"
3. Кликните на дату для разворачивания
4. Посмотрите таблицу всех анализов

Фильтрация:
- Выберите "Только успешные"
- Увидите только валидные компасы

Детали:
- Нажмите 👁️ на любом анализе
- Посмотрите полную информацию
- График, повороты, лог - всё сохранено!
```

---

### Пример 4: Настройка параметров

```
Задача: Сделать анализ более строгим

Шаги:
1. Вкладка "Настройки"
2. Изменить параметры:
   - Порог стабильности: 3.0° (было 5.0°)
   - Допуск поворота: 8.0° (было 10.0°)
3. Посмотреть Live Preview
4. Нажать "Сохранить настройки"

Применение:
✅ Все новые анализы будут использовать новые параметры!

Проверка:
- Сделайте анализ с новыми настройками
- Сравните с предыдущими из истории
```

---

## 🔍 Отладка

### Если что-то не работает:

#### 1. Откройте консоль браузера (F12)

**Проверьте логи:**
```javascript
displayResults: Received data: {...}
💾 Сохранено в историю: 1903
⚙️ Настройки загружены: {...}
```

#### 2. Откройте окно PowerShell с сервером

**Проверьте серверные логи:**
```
📥 Получен запрос на анализ: H:\Study\Успех\1903
🔍 Начало анализа папки: H:\Study\Успех\1903
✅ CSV файл найден
✅ Прочитано записей: 123
✅ Извлечено углов: 123
✅ Анализ завершен: isValid=true, найдено поворотов=4
   Поворот 1: 156.25° → 246.67° (Δ=90.42°)
   ...
📤 Отправка ответа: Success=true, IsValid=true, Turns=4, Angles=123
```

#### 3. Общие проблемы:

**Ошибка: "Файл SB_CMPS.csv не найден"**
- Проверьте путь (должен быть полным)
- Файл должен быть в корне папки

**Ошибка: "Cannot read properties of null"**
- Обновите страницу (Ctrl+F5)
- Очистите кеш браузера

**История не показывается**
- Проверьте консоль: `localStorage.getItem('compassHistory')`
- Если null - сделайте хотя бы один анализ

**Настройки не сохраняются**
- Проверьте консоль: `localStorage.getItem('compassSettings')`
- Убедитесь, что localStorage не заблокирован

---

## ✨ Все новые функции (версия 2.1)

### ✅ Реализовано:

1. **Цветовое выделение зоны поворотов** 🔵
   - Синие точки в зоне поворотов
   - Серые - остальные
   - Легенда на графике

2. **История с группировкой по дням** 📅
   - Аккордеон по датам
   - Автоматическое раскрытие сегодняшнего дня
   - Статистика успешных/неудачных

3. **Фильтры истории** 🔍
   - По статусу (все/успешные/ошибки)
   - По дате (весь период/сегодня/конкретная дата)
   - Кнопка сброса фильтров

4. **Детальный просмотр из истории** 👁️
   - Кнопка просмотра для каждой записи
   - Полная информация сохранена
   - График, повороты, лог

5. **Сохранение пакетной обработки** 💾
   - Автоматическое добавление в историю
   - Каждый компас - отдельная запись

6. **Функциональные настройки** ⚙️
   - Изменение всех параметров алгоритма
   - Live Preview
   - Сохранение в localStorage
   - Валидация значений
   - Сброс по умолчанию

7. **Два варианта загрузки** 📁
   - Ввод пути вручную
   - Выбор через диалог

8. **Улучшенный tooltip** 💬
   - Сначала угол, потом индекс
   - Индикатор зоны поворотов 🔵

---

## 🎓 Рекомендации по использованию

### Ежедневная работа:

```
Утро:
1. Запустить start_web.bat
2. Вкладка "Пакетный"
3. Ввести путь к папке с новыми компасами
4. Запустить анализ
5. Просмотреть результаты
6. Проверить детали проблемных (👁️)

Конец дня:
1. Вкладка "История"
2. Посмотреть статистику за день
3. Экспортировать важные результаты
```

### Настройка алгоритма:

```
Если слишком много ложных ошибок:
→ Увеличить "Допуск поворота" (12.0°)
→ Увеличить "Порог стабильности" (7.0°)

Если пропускаются реальные ошибки:
→ Уменьшить "Допуск поворота" (8.0°)
→ Уменьшить "Порог стабильности" (3.0°)
```

### Работа с историей:

```
Найти все успешные за неделю:
1. Фильтр статуса: "Только успешные"
2. Фильтр даты: "Весь период"
3. Просмотр всех успешных проверок

Проверить конкретный день:
1. Фильтр даты: выбрать нужную дату
2. Раскрыть секцию
3. Просмотреть детали
```

---

## 📁 Структура данных

### История (localStorage):
```json
{
  "compassHistory": [
    {
      "id": "1698489600000_abc123",
      "timestamp": 1698489600000,
      "compass": "1903",
      "isValid": true,
      "turnsCount": 4,
      "anglesCount": 123,
      "fullData": {
        "success": true,
        "isValid": true,
        "compass": "1903",
        "turns": [...],
        "allAngles": [...],
        "segments": [...],
        "log": "..."
      }
    }
  ]
}
```

### Настройки (localStorage):
```json
{
  "compassSettings": {
    "stabilityThreshold": 5.0,
    "turnTolerance": 10.0,
    "minSegmentLength": 3,
    "maxOutliers": 2
  }
}
```

---

## 🛠️ Техническая информация

### Технологии:
- **Backend**: Go 1.21+
- **Frontend**: Vanilla JavaScript (без фреймворков!)
- **Графики**: Chart.js 4.4.0
- **Хранилище**: localStorage (браузер)
- **Стили**: Custom CSS с CSS переменными

### Производительность:
- **Загрузка истории**: < 100ms для 200 записей
- **Фильтрация**: < 50ms (клиентская)
- **Рендеринг графика**: < 200ms
- **Пакетный анализ**: ~100ms на компас

### Размер данных:
- **История (200 записей)**: ~5-10 МБ
- **Настройки**: < 1 КБ
- **Один анализ**: ~20-50 КБ

---

## 🔐 Безопасность и ограничения

### localStorage:
- ⚠️ Данные хранятся в браузере
- ⚠️ При очистке кеша - данные удалятся
- ⚠️ Доступны только в этом браузере
- ✅ Не передаются на сервер без явного экспорта

### Рекомендации:
- Регулярно экспортируйте важные результаты
- Делайте backup истории (экспорт в JSON)
- Не очищайте кеш браузера без необходимости

---

## 📞 Поддержка

Если возникли проблемы:
1. Проверьте консоль браузера (F12)
2. Проверьте окно PowerShell с сервером
3. Попробуйте жесткое обновление (Ctrl+F5)
4. Очистите localStorage и начните заново:
   ```javascript
   // В консоли браузера:
   localStorage.clear();
   location.reload();
   ```

---

**Автор**: Ульянов Александр, Регулировщик 3-го разряда  
**Версия**: 2.1.0 - Advanced Features Edition  
**Дата**: 28 октября 2025, 14:15

**Все функции реализованы и готовы к использованию!** 🎉

